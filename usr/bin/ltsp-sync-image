#!/bin/sh

if cd /mnt/images; then


if test -z "$1"; then
  SERVER="http://172.16.42.10"
  PATH="ltsp-images"
  #SERVER=$(/usr/bin/getltscfg IMAGE_SERVER)
  #PATH=$(/usr/bin/getltscfg IMAGE_PATH)
  ALL="$SERVER/$PATH"
else
  ALL="$1"
fi

if test -f version; then
  VERSION=$(/bin/cat version)
else
  VERSION=0
  /bin/touch version
  echo "0" > version
fi


VERSION_neu="$(/usr/bin/wget -O - ${ALL}/version 2>/dev/null)"

if test -z "$VERSION_neu"; then echo "could not read new version:${VERSION_neu}:";exit 1; fi
 

if test "$VERSION"  = "$VERSION_neu"; then
  echo "nicht zu tun"
else
  echo "copy $(/usr/bin/printf "%06i.img" $VERSION) to $(/usr/bin/printf "%06i.img" $VERSION_neu)..."
  /bin/cp $(/usr/bin/printf "%06i.img" $VERSION) $(/usr/bin/printf "%06i.img" $VERSION_neu) 
  echo "zsync..." 
  if /usr/bin/zsync "${ALL}/$(/usr/bin/printf "%06i.img" $VERSION_neu).zsync"; then
    # sync meta info
    echo "rm primary"
    /bin/rm primary-image-*
    echo "wget primary"
    /usr/bin/wget ${ALL}/primary-image-$(/usr/bin/printf "%06i" $VERSION_neu)
   echo "rm version"
    /bin/rm version
    echo "wget version"
    /usr/bin/wget ${ALL}/version
    echo "fertig"

    #remove old images
    echo "remove oldies"
    if test -f $(/usr/bin/printf "%06i.img" $(( $VERSION -3 ))); then
      /bin/rm $(/usr/bin/printf "%06i.img" $(( $VERSION -3 )))
    fi
    /bin/rm *.old
    echo "ok"
  fi
fi

else # if cd /mnt/images
  echo "error: could not cd to /mnt/images"
fi
exit
