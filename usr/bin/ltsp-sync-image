#!/bin/sh

cd /mnt/images

SERVER="http://172.16.42.10/"

if test -f version; then
  VERSION=$(cat version)
else
  VERSION=0
fi

VERSION_neu="$(wget -O - ${SERVER}/ltsp-images/version 2>/dev/null)"

if test -z "$VERSION_neu"; then exit
 

if test "$VERSION"  = "$VERSION_neu"; then
  echo "nicht zu tun"
else
  neu=$(printf "%06i.img" $VERSION_neu)
  echo "copy"
  cp $(printf "%06i.img" $VERSION) $neu
  echo "zsync" 
  zsync "${SERVER}ltsp-images/${neu}.zsync"
  rm primary-image-*
  wget ${SERVER}ltsp-images/primary-image-$(printf "%06i" $VERSION_neu)
  rm version
  wget ${SERVER}ltsp-images/version
  echo "fertig"
  echo $VERSION_neu > version
  if test $(printf "%06i.img" $(( $VERSION -10 ))); then
     rm $(printf "%06i.img" $(( $VERSION -10 )))
  fi
fi

exit
