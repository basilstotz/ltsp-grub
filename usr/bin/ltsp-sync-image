#!/bin/sh

cd /mnt/images

SERVER=$(getltspcfg IMAGE_SERVER)
PATH=$(getltspcfg IMAGE_PATH)

if test -f version; then
  VERSION=$(cat version)
else
  VERSION=0
fi

VERSION_neu="$(wget -O - ${SERVER}/${PATH}/version 2>/dev/null)"

if test -z "$VERSION_neu"; then exit
 

if test "$VERSION"  = "$VERSION_neu"; then
  echo "nicht zu tun"
else
  neu=$(printf "%06i.img" $VERSION_neu)
  echo "copy"
  cp $(printf "%06i.img" $VERSION) $neu
  echo "zsync" 
  zsync "${SERVER}/${PATH}/${neu}.zsync"
  rm primary-image-*
  wget ${SERVER}/${PATH}/primary-image-$(printf "%06i" $VERSION_neu)
  rm version
  wget ${SERVER}/${PATH}/version
  echo "fertig"
  echo $VERSION_neu > version

  #remove old images
  if test $(printf "%06i.img" $(( $VERSION -10 ))); then
     rm $(printf "%06i.img" $(( $VERSION -10 )))
  fi
fi

exit
